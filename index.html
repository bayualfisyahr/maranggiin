<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Bisnis Sate Maranggi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Culinary (Stone, Amber) -->
    <!-- Application Structure Plan: A multi-section single-page application with a fixed sidebar for desktop and a hamburger menu for mobile. The structure is task-oriented: 1) Bisnis Plan (Strategic Overview), 2) Panduan Resep (Operational Reference), 3) Dashboard Penjualan (Performance Tracking), 4) Data Kas (Daily Data Entry). This separation clarifies the user flow and makes the tool more powerful for day-to-day management. -->
    <!-- Visualization & Content Choices: Report Info: Sales Performance -> Goal: Track Progress -> Viz/Method: Dynamic stat cards and a Chart.js gauge/doughnut chart -> Interaction: Data is automatically updated from the 'Data Kas' entries. Justification: Provides an immediate, at-a-glance view of performance against targets. Report Info: Cash Flow -> Goal: Record Transactions -> Viz/Method: HTML form and a dynamic table -> Interaction: User can add and delete entries, which then update the entire dashboard. Justification: This is the core engine for making the dashboard a practical daily tool. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .sidebar-link.active { background-color: #f59e0b; color: white; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .modal { transition: opacity 0.3s ease-in-out; }
        .chart-container { position: relative; width: 100%; height: 300px; max-height: 40vh; margin-top: 2rem; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
    <div class="flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-stone-800 text-white w-64 min-h-screen p-4 fixed md:relative transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-30">
            <h1 class="text-2xl font-bold text-amber-400 mb-8 text-center">Sate Maranggi</h1>
            <nav class="flex flex-col space-y-2">
                <a href="#bisnis-plan" class="sidebar-link active flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üìÑ</span> Bisnis Plan
                </a>
                <a href="#resep" class="sidebar-link flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üç≤</span> Panduan Resep
                </a>
                <a href="#dashboard" class="sidebar-link flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üìä</span> Dashboard Penjualan
                </a>
                 <a href="#pre-order" class="sidebar-link flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üì¶</span> Data Pesanan
                </a>
                <a href="#data-kas" class="sidebar-link flex items-center py-2 px-4 rounded-lg hover:bg-amber-500 transition">
                    <span class="mr-3">üí∞</span> Data Kas
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1">
            <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-10 shadow-sm flex items-center p-4 md:hidden">
                <button id="menu-btn" class="text-stone-800 mr-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h2 id="header-title" class="text-xl font-bold text-amber-600">Bisnis Plan</h2>
            </header>

            <main class="p-6 md:p-8 pb-16">
                <!-- Section: Bisnis Plan -->
                <section id="bisnis-plan" class="content-section active">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Rencana Bisnis Strategis</h2>
                    <div class="space-y-8">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-2xl font-bold mb-4">Analisis Menu & Titik Impas (BEP)</h3>
                            <div id="menu-analysis-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Konten Analisis Menu Dibuat oleh JavaScript -->
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-2xl font-bold mb-4">Rincian Modal Awal & Operasional</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- Biaya Investasi -->
                                <div>
                                    <h4 class="text-xl font-semibold mb-3">Biaya Investasi (Sekali Bayar)</h4>
                                    <div id="investment-cost-container" class="space-y-2">
                                        <!-- Diisi oleh JS -->
                                    </div>
                                    <button id="add-investment-btn" class="mt-3 w-full text-sm bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">+ Tambah Biaya Investasi</button>
                                    <div class="flex justify-between font-bold text-lg mt-4 border-t pt-2">
                                        <span>Total Investasi:</span>
                                        <span id="total-investment">Rp 0</span>
                                    </div>
                                </div>
                                <!-- Biaya Operasional -->
                                <div>
                                    <h4 class="text-xl font-semibold mb-3">Biaya Operasional (Bulanan)</h4>
                                    <div id="operational-cost-container" class="space-y-2">
                                        <!-- Diisi oleh JS -->
                                    </div>
                                    <button id="add-operational-btn" class="mt-3 w-full text-sm bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">+ Tambah Biaya Operasional</button>
                                    <div class="flex justify-between font-bold text-lg mt-4 border-t pt-2">
                                        <span>Total Operasional/Bulan:</span>
                                        <span id="total-operational">Rp 0</span>
                                    </div>
                                </div>
                            </div>
                             <div class="mt-8 border-t-2 border-amber-500 pt-4 bg-amber-50 p-4 rounded-lg">
                                <h4 class="text-xl font-bold text-amber-800">Total Modal Keseluruhan</h4>
                                <p class="text-sm text-stone-600">(Total Investasi + 1 Bulan Biaya Operasional)</p>
                                <p id="total-modal-keseluruhan" class="text-3xl font-bold text-amber-600 mt-2">Rp 0</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section: Panduan Resep -->
                <section id="resep" class="content-section">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl md:text-4xl font-bold">Panduan Resep</h2>
                        <button id="add-recipe-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition">+ Tambah Resep</button>
                    </div>
                    <div id="recipe-container" class="space-y-8">
                        <!-- Konten Resep Dibuat oleh JavaScript -->
                    </div>
                </section>

                <!-- Section: Dashboard Penjualan -->
                <section id="dashboard" class="content-section">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Dashboard Penjualan</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-stone-500 mb-2">Target Capaian Bulanan</h3>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-3xl font-bold text-amber-500">Rp</span>
                                    <input id="target-rupiah" type="text" placeholder="15.000.000" class="text-3xl font-bold text-amber-600 bg-amber-50 w-full focus:outline-none focus:ring-2 focus:ring-amber-300 border-none p-2 pl-12 rounded-lg">
                                </div>
                            </div>
                            <div class="md:border-l md:pl-6">
                                <label for="target-harian" class="font-semibold">Target Penjualan Harian (Porsi)</label>
                                <div class="flex items-center space-x-4 mt-2">
                                    <input id="target-harian" type="range" min="10" max="100" step="1" value="30" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-amber-500">
                                    <span id="target-harian-value" class="font-bold text-amber-600 text-lg w-24 text-right">30 Porsi</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-stone-500 mb-2">Target Pemasukan Bulan Ini</h3>
                            <p id="target-bulanan" class="text-3xl font-bold text-amber-600">Rp 0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-stone-500 mb-2">Laba Kotor Aktual</h3>
                            <p id="laba-kotor" class="text-3xl font-bold text-blue-600">Rp 0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-stone-500 mb-2">Laba Bersih Aktual</h3>
                            <p id="laba-bersih" class="text-3xl font-bold text-green-600">Rp 0</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-stone-500 mb-2">Kekurangan Menuju Target</h3>
                            <p id="kekurangan-target" class="text-3xl font-bold text-red-500">Rp 0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow mt-6">
                        <h3 class="text-xl font-bold mb-4">Tren Pemasukan Harian (Bulan Ini)</h3>
                        <div class="chart-container">
                            <canvas id="sales-trend-chart"></canvas>
                        </div>
                    </div>
                </section>
                
                <!-- Section: Pre-order -->
                <section id="pre-order" class="content-section">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Data Pesanan (Pre-order)</h2>
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h3 class="text-xl font-bold mb-4">Formulir Pesanan Baru</h3>
                        <form id="pre-order-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="po-customer" class="block text-sm font-bold text-stone-700 mb-1">Nama Pemesan</label>
                                    <input type="text" id="po-customer" class="bg-stone-100 w-full rounded p-3" required>
                                </div>
                                <div>
                                    <label for="po-date" class="block text-sm font-bold text-stone-700 mb-1">Tgl Pengambilan</label>
                                    <input type="date" id="po-date" class="bg-stone-100 w-full rounded p-3" required>
                                </div>
                            </div>
                            <div>
                                <label for="po-details" class="block text-sm font-bold text-stone-700 mb-1">Detail Pesanan</label>
                                <textarea id="po-details" rows="3" class="bg-stone-100 w-full rounded p-3" placeholder="Contoh: 5 porsi Sate Sapi, 2 porsi Sate Kambing" required></textarea>
                            </div>
                             <div>
                                <label for="po-amount" class="block text-sm font-bold text-stone-700 mb-1">Total Harga (Rp)</label>
                                <input type="number" id="po-amount" class="bg-stone-100 w-full rounded p-3" required>
                            </div>
                            <button type="submit" class="w-full md:w-auto bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition">Simpan Pesanan</button>
                        </form>
                    </div>
                    <div class="flex justify-center mb-6">
                        <div class="bg-white p-4 rounded-lg shadow inline-flex space-x-6">
                            <div class="text-center">
                                <p class="text-2xl font-bold text-blue-600" id="po-proses">0</p>
                                <p class="text-sm text-stone-500">Dalam Proses</p>
                            </div>
                             <div class="text-center">
                                <p class="text-2xl font-bold text-green-600" id="po-selesai">0</p>
                                <p class="text-sm text-stone-500">Selesai</p>
                            </div>
                        </div>
                    </div>
                    <div id="pre-order-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                         <!-- Diisi oleh JS -->
                    </div>
                </section>

                <!-- Section: Data Kas -->
                <section id="data-kas" class="content-section">
                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Data Kas</h2>
                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h3 class="text-xl font-bold mb-4">Formulir Transaksi</h3>
                        <form id="transaction-form" class="space-y-4">
                            <div>
                                <label for="tx-date" class="block text-sm font-bold text-stone-700 mb-1">Tanggal</label>
                                <input type="date" id="tx-date" class="bg-stone-100 p-3 mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" required>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="tx-type" class="block text-sm font-bold text-stone-700 mb-1">Jenis</label>
                                    <select id="tx-type" class="bg-stone-100 p-3 mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-500 focus:ring-amber-500">
                                        <option>Pemasukan</option>
                                        <option>Pengeluaran</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="tx-category" class="block text-sm font-bold text-stone-700 mb-1">Kategori</label>
                                    <select id="tx-category" class="bg-stone-100 p-3 mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-500 focus:ring-amber-500"></select>
                                </div>
                            </div>
                            <div>
                                <label for="tx-amount" class="block text-sm font-bold text-stone-700 mb-1">Jumlah (Rp)</label>
                                <input type="number" id="tx-amount" placeholder="50000" class="bg-stone-100 p-3 mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-500 focus:ring-amber-500" required>
                            </div>
                            <button type="submit" class="w-full bg-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-amber-600 transition">Tambah Transaksi</button>
                        </form>
                    </div>
                    <div id="transaction-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Riwayat Transaksi Card-based -->
                    </div>
                </section>
            </main>
        </div>
    </div>
    
    <!-- All Modals -->
    <div id="edit-tx-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center"> <!-- Modal Edit Transaksi --> </div>
    <div id="kelola-menu-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center"> <!-- Modal Kelola Menu --> </div>
    <div id="recipe-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center"> <!-- Modal Resep --> </div>

    <script type="module">
        /* ==== Firebase Imports & Setup ==== */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC_Z8QS_mNbExzIoppP_0EbABM4Y1eeVTQ",
            authDomain: "dasbor-maranggiin.firebaseapp.com",
            projectId: "dasbor-maranggiin",
            storageBucket: "dasbor-maranggiin.firebasestorage.app",
            messagingSenderId: "476865235556",
            appId: "1:476865235556:web:f1dd8a2dfd93c623b1ad71",
            measurementId: "G-QMD7ZLZ20Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* ==== App Code (as requested, lengkap) ==== */
        document.addEventListener('DOMContentLoaded', function () {
            let businessData = {
                modal: {
                    investment: [{ name: "Gerobak / Tenda", cost: 1500000 }, { name: "Alat Bakar", cost: 300000 }, { name: "Kompor & Gas", cost: 250000 }, { name: "Peralatan Masak & Makan", cost: 400000 }, { name: "Banner", cost: 100000 }],
                    operational: [{ name: "Sewa Lapak", cost: 300000 }, { name: "Transportasi", cost: 200000 }, { name: "Gas & Arang", cost: 150000 }]
                },
                hariKerjaPerBulan: 25,
                targetBulananRp: 15000000,
                menu: [
                    { 
                        id: 'sate-sapi', name: 'Sate Maranggi Sapi', hargaJual: 30000,
                        hppBreakdown: [{ name: 'Daging Sapi (100gr)', cost: 14000 }, { name: 'Bumbu & Kecap', cost: 5000 }, { name: 'Nasi/Lontong', cost: 2500 }, { name: 'Kemasan & Lainnya', cost: 1500 }],
                        resep: { C1_label: "Bumbu Marinasi", C1_content: "Bawang Merah: 10 siung\nBawang Putih: 8 siung\nLengkuas: 3 cm\nKetumbar Sangrai: 2 sdt", C2_label: "Sambal", C2_content: "Tomat Merah: 3 buah\nCabai Rawit: 15-20 buah", C3_label: "Langkah Pembuatan", C3_content: "Campur daging dengan bumbu halus.\nMarinasi di kulkas minimal 3 jam."}
                    }
                ],
                categories: { Pemasukan: ["Penjualan Harian", "Penjualan Pre-order"], Pengeluaran: ["Bahan Baku", "Sewa Lapak", "Operasional", "Transportasi", "Lain-lain"] }
            };
            
            let transactions = [];
            let preOrders = [];
            let salesTrendChart;

            const formatCurrency = (value) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value);
            const formatNumber = (value) => new Intl.NumberFormat('id-ID').format(value);
            
            const DOMElements = {
                sidebar: document.getElementById('sidebar'), sidebarOverlay: document.getElementById('sidebar-overlay'), menuBtn: document.getElementById('menu-btn'), headerTitle: document.getElementById('header-title'),
                sidebarLinks: document.querySelectorAll('.sidebar-link'), contentSections: document.querySelectorAll('.content-section'), targetHarianSlider: document.getElementById('target-harian'),
                targetHarianValue: document.getElementById('target-harian-value'), targetBulananEl: document.getElementById('target-bulanan'), labaKotorEl: document.getElementById('laba-kotor'),
                labaBersihEl: document.getElementById('laba-bersih'), kekuranganTargetEl: document.getElementById('kekurangan-target'), txForm: document.getElementById('transaction-form'),
                txDate: document.getElementById('tx-date'), txType: document.getElementById('tx-type'), txCategory: document.getElementById('tx-category'), txAmount: document.getElementById('tx-amount'),
                transactionList: document.getElementById('transaction-list'), recipeContainer: document.getElementById('recipe-container'), menuAnalysisContainer: document.getElementById('menu-analysis-container'),
                editTxModal: document.getElementById('edit-tx-modal'), kelolaMenuModal: document.getElementById('kelola-menu-modal'), recipeModal: document.getElementById('recipe-modal'),
                targetRupiahInput: document.getElementById('target-rupiah'), addRecipeBtn: document.getElementById('add-recipe-btn'),
                preOrderForm: document.getElementById('pre-order-form'), preOrderList: document.getElementById('pre-order-list'),
                poProses: document.getElementById('po-proses'), poSelesai: document.getElementById('po-selesai')
            };

            /* ===== Local save/load (tetap ada) ===== */
            function saveData() {
                localStorage.setItem('businessData', JSON.stringify(businessData));
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('preOrders', JSON.stringify(preOrders));
            }

            function loadData() {
                const loadedBusinessData = JSON.parse(localStorage.getItem('businessData'));
                const loadedTransactions = JSON.parse(localStorage.getItem('transactions'));
                const loadedPreOrders = JSON.parse(localStorage.getItem('preOrders'));
                if (loadedBusinessData) businessData = loadedBusinessData;
                if (loadedTransactions) transactions = loadedTransactions;
                if (loadedPreOrders) preOrders = loadedPreOrders;
            }

            function toggleSidebar() { DOMElements.sidebar.classList.toggle('-translate-x-full'); DOMElements.sidebarOverlay.classList.toggle('hidden'); }
            
            function renderAll() {
                renderTransactions();
                renderRecipes();
                renderMenuAnalysis();
                renderCapitalPlan();
                renderPreOrders();
                updateDashboard();
            }

            function setupNavigation() {
                DOMElements.menuBtn.addEventListener('click', toggleSidebar);
                DOMElements.sidebarOverlay.addEventListener('click', toggleSidebar);
                DOMElements.sidebarLinks.forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const targetId = link.getAttribute('href').substring(1);
                        DOMElements.contentSections.forEach(s => s.classList.remove('active'));
                        document.getElementById(targetId).classList.add('active');
                        DOMElements.sidebarLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        DOMElements.headerTitle.textContent = link.textContent.trim();
                        if (window.innerWidth < 768) toggleSidebar();
                    });
                });
            }

            function populateCategories(selectEl, type) {
                selectEl.innerHTML = '';
                businessData.categories[type].forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat; option.textContent = cat;
                    selectEl.appendChild(option);
                });
            }

            function renderTransactions() {
                const container = DOMElements.transactionList;
                container.innerHTML = '';
                if (transactions.length === 0) {
                    container.innerHTML = `<p class="text-stone-500 italic md:col-span-3">Belum ada transaksi.</p>`;
                    return;
                }
                const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                sorted.forEach(tx => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-4 rounded-lg shadow';
                    const isPemasukan = tx.type === 'Pemasukan';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold">${tx.category}</p>
                                <p class="text-sm text-stone-500">${new Date(tx.date).toLocaleDateString('id-ID')}</p>
                            </div>
                            <p class="font-bold text-lg ${isPemasukan ? 'text-green-600' : 'text-red-600'}">${isPemasukan ? '+' : '-'} ${formatCurrency(tx.amount)}</p>
                        </div>
                        <div class="text-right mt-2">
                            <button data-id="${tx.id}" class="edit-btn text-blue-500 hover:underline text-xs font-semibold">Edit</button>
                            <button data-id="${tx.id}" class="delete-btn text-red-500 hover:underline text-xs font-semibold ml-2">Hapus</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            
            function updateDashboard() {
                const targetBulananRp = businessData.targetBulananRp || 0;
                DOMElements.targetBulananEl.textContent = formatCurrency(targetBulananRp);

                const now = new Date();
                const monthlyTx = transactions.filter(tx => new Date(tx.date).getMonth() === now.getMonth() && new Date(tx.date).getFullYear() === now.getFullYear());
                const totalPemasukan = monthlyTx.filter(tx => tx.type === 'Pemasukan').reduce((s, tx) => s + tx.amount, 0);
                const totalPengeluaran = monthlyTx.filter(tx => tx.type === 'Pengeluaran').reduce((s, tx) => s + tx.amount, 0);
                const totalBiayaOperasional = businessData.modal.operational.reduce((sum, item) => sum + (item.cost || 0), 0);
                const labaKotor = totalPemasukan - totalPengeluaran;
                const labaBersih = labaKotor - totalBiayaOperasional;
                const kekurangan = Math.max(0, targetBulananRp - totalPemasukan);
                
                DOMElements.labaKotorEl.textContent = formatCurrency(labaKotor);
                DOMElements.labaBersihEl.textContent = formatCurrency(labaBersih);
                DOMElements.kekuranganTargetEl.textContent = formatCurrency(kekurangan);
                updateSalesTrendChart();
            }

            function updateTargetSlider() {
                const targetBulananRp = businessData.targetBulananRp || 0;
                let avgPrice = businessData.menu.reduce((a, i) => a + i.hargaJual, 0) / businessData.menu.length;
                if (!isFinite(avgPrice) || avgPrice === 0) avgPrice = 30000;
                
                const requiredMonthlyPortions = targetBulananRp / avgPrice;
                const requiredDailyPortions = Math.ceil(requiredMonthlyPortions / businessData.hariKerjaPerBulan);
                
                DOMElements.targetHarianSlider.value = requiredDailyPortions;
                DOMElements.targetHarianValue.textContent = `${requiredDailyPortions} Porsi`;
            }

            /* ===== Firestore CRUD ===== */
            async function saveTransactionFB(tx) { await addDoc(collection(db, "transactions"), tx); }
            async function getTransactionsFB() {
                const snap = await getDocs(collection(db, "transactions"));
                return snap.docs.map(d => ({ id: d.id, ...d.data() }));
            }
            async function updateTransactionFB(id, tx) { await updateDoc(doc(db, "transactions", id), tx); }
            async function deleteTransactionFB(id) { await deleteDoc(doc(db, "transactions", id)); }

            async function savePreOrderFB(po) { await addDoc(collection(db, "preorders"), po); }
            async function getPreOrdersFB() {
                const snap = await getDocs(collection(db, "preorders"));
                return snap.docs.map(d => ({ id: d.id, ...d.data() }));
            }
            async function completePreOrderFB(id, order) {
                await updateDoc(doc(db, "preorders", id), { status: "selesai" });
                await addDoc(collection(db, "transactions"), {
                    date: new Date().toISOString().split('T')[0],
                    type: "Pemasukan",
                    category: "Penjualan Pre-order",
                    amount: order.amount
                });
            }

            /* ===== App Actions (diubah agar pakai Firestore) ===== */
            async function addTransaction(e) {
                const tx = { 
                    date: DOMElements.txDate.value, 
                    type: DOMElements.txType.value, 
                    category: DOMElements.txCategory.value, 
                    amount: parseInt(DOMElements.txAmount.value) || 0 
                };
                await saveTransactionFB(tx);
                transactions = await getTransactionsFB();
                saveData(); renderTransactions(); updateDashboard(); DOMElements.txForm.reset(); DOMElements.txDate.valueAsDate = new Date();
            }
            
            async function deleteTransaction(id) {
                await deleteTransactionFB(id);
                transactions = await getTransactionsFB();
                saveData(); renderTransactions(); updateDashboard();
            }

            function openEditModal(id) {
                const tx = transactions.find(t => t.id === id);
                DOMElements.editTxModal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
                    <h3 class="text-2xl font-bold mb-4">Edit Transaksi</h3>
                    <form id="edit-tx-form">
                        <input type="hidden" id="edit-tx-id" value="\${tx.id}">
                        <div class="space-y-4">
                            <div><label for="edit-tx-date" class="block text-sm font-bold text-stone-700 mb-1">Tanggal</label><input type="date" id="edit-tx-date" value="\${tx.date}" class="bg-stone-50 mt-1 block w-full rounded-md border-stone-300 shadow-sm" required></div>
                            <div><label for="edit-tx-category" class="block text-sm font-bold text-stone-700 mb-1">Kategori</label><select id="edit-tx-category" class="bg-stone-50 mt-1 block w-full rounded-md border-stone-300 shadow-sm"></select></div>
                            <div><label for="edit-tx-amount" class="block text-sm font-bold text-stone-700 mb-1">Jumlah (Rp)</label><input type="number" id="edit-tx-amount" value="\${tx.amount}" class="bg-stone-50 mt-1 block w-full rounded-md border-stone-300 shadow-sm" required></div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" class="cancel-modal-btn bg-stone-200 text-stone-800 font-bold py-2 px-4 rounded-lg hover:bg-stone-300">Batal</button>
                            <button type="submit" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600">Simpan</button>
                        </div>
                    </form>
                </div>`;
                const catSelect = DOMElements.editTxModal.querySelector('#edit-tx-category');
                populateCategories(catSelect, tx.type);
                catSelect.value = tx.category;
                DOMElements.editTxModal.classList.remove('hidden');
                DOMElements.editTxModal.classList.add('flex');
            }

            async function saveEditTransaction(e) {
                const id = e.target.querySelector('#edit-tx-id').value;
                const newDate = e.target.querySelector('#edit-tx-date').value;
                const newCategory = e.target.querySelector('#edit-tx-category').value;
                const newAmount = parseInt(e.target.querySelector('#edit-tx-amount').value) || 0;
                await updateTransactionFB(id, { date: newDate, category: newCategory, amount: newAmount });
                transactions = await getTransactionsFB();
                saveData(); renderTransactions(); updateDashboard();
                DOMElements.editTxModal.classList.add('hidden');
            }
            
            function renderRecipes() {
                DOMElements.recipeContainer.innerHTML = businessData.menu.map(item => {
                    const c1 = item.resep.C1_content ? `<div><h4 class="text-xl font-semibold mb-3">${item.resep.C1_label || 'Komponen 1'}:</h4><ul class="list-disc list-inside text-stone-600 space-y-2">${item.resep.C1_content.split('\n').map(b => `<li>${b}</li>`).join('')}</ul></div>` : '';
                    const c2 = item.resep.C2_content ? `<div><h4 class="text-xl font-semibold mb-3">${item.resep.C2_label || 'Komponen 2'}:</h4><ul class="list-disc list-inside text-stone-600 space-y-2">${item.resep.C2_content.split('\n').map(s => `<li>${s}</li>`).join('')}</ul></div>` : '';
                    const c3 = item.resep.C3_content ? `<div class="mt-6 pt-4 border-t md:col-span-2"><h4 class="text-xl font-semibold mb-3">${item.resep.C3_label || 'Langkah Pembuatan'}:</h4><ol class="list-decimal list-inside text-stone-600 space-y-2">${item.resep.C3_content.split('\n').map(l => `<li>${l}</li>`).join('')}</ol></div>` : '';

                    return `
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl md:text-2xl font-bold mb-4 border-b pb-2 flex-1">${item.name}</h3>
                            <button data-id="${item.id}" class="kelola-resep-btn text-xs bg-stone-100 text-stone-800 font-semibold px-2 py-1 rounded hover:bg-stone-200 ml-4">Kelola</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                           ${c1}
                           ${c2}
                           ${c3}
                        </div>
                    </div>`;
                }).join('');
            }

            function openRecipeModal(menuId = null) {
                const isNew = menuId === null;
                const menu = isNew ? { id: `menu-${Date.now()}`, name: '', resep: { C1_label: 'Bahan Utama', C1_content: '', C2_label: 'Pelengkap', C2_content: '', C3_label: 'Langkah Pembuatan', C3_content: '' } } : businessData.menu.find(m => m.id === menuId);
                DOMElements.recipeModal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4">
                    <h3 class="text-xl md:text-2xl font-bold mb-4">${isNew ? 'Tambah Resep Baru' : 'Edit Resep'}</h3>
                    <form id="recipe-form" class="space-y-4 max-h-[80vh] overflow-y-auto pr-4">
                        <input type="hidden" id="recipe-id" value="${menu.id}">
                        <div><label for="recipe-name" class="block text-sm font-bold text-stone-700 mb-1">Nama Menu</label><input type="text" id="recipe-name" value="${menu.name}" class="bg-stone-50 w-full rounded" required></div>
                        
                        <div><label class="block text-sm font-bold text-stone-700 mb-1">Judul Komponen 1</label><input type="text" id="recipe-c1-label" value="${menu.resep.C1_label || ''}" class="bg-stone-50 w-full rounded"></div>
                        <div><label for="recipe-c1-content" class="block text-sm font-bold text-stone-700 mb-1">Isi Komponen 1 (satu baris per item)</label><textarea id="recipe-c1-content" rows="5" class="bg-stone-50 w-full rounded">${menu.resep.C1_content || ''}</textarea></div>
                        
                        <div><label class="block text-sm font-bold text-stone-700 mb-1">Judul Komponen 2</label><input type="text" id="recipe-c2-label" value="${menu.resep.C2_label || ''}" class="bg-stone-50 w-full rounded"></div>
                        <div><label for="recipe-c2-content" class="block text-sm font-bold text-stone-700 mb-1">Isi Komponen 2 (satu baris per item)</label><textarea id="recipe-c2-content" rows="3" class="bg-stone-50 w-full rounded">${menu.resep.C2_content || ''}</textarea></div>
                        
                        <div><label class="block text-sm font-bold text-stone-700 mb-1">Judul Langkah</label><input type="text" id="recipe-c3-label" value="${menu.resep.C3_label || ''}" class="bg-stone-50 w-full rounded"></div>
                        <div><label for="recipe-c3-content" class="block text-sm font-bold text-stone-700 mb-1">Isi Langkah (satu baris per item)</label><textarea id="recipe-c3-content" rows="5" class="bg-stone-50 w-full rounded">${menu.resep.C3_content || ''}</textarea></div>
                        
                        <div class="flex justify-between items-center pt-4">
                            <div>${!isNew ? '<button type="button" id="delete-recipe-btn" class="bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200">Hapus Resep Ini</button>' : '<div></div>'}</div>
                            <div class="flex space-x-3">
                                <button type="button" class="cancel-modal-btn bg-stone-200 text-stone-800 font-bold py-2 px-4 rounded-lg hover:bg-stone-300">Batal</button>
                                <button type="submit" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600">Simpan Resep</button>
                            </div>
                        </div>
                    </form>
                </div>`;
                DOMElements.recipeModal.classList.remove('hidden');
                DOMElements.recipeModal.classList.add('flex');
            }

            function saveRecipe(e) {
                const id = e.target.querySelector('#recipe-id').value;
                const name = e.target.querySelector('#recipe-name').value;
                const C1_label = e.target.querySelector('#recipe-c1-label').value;
                const C1_content = e.target.querySelector('#recipe-c1-content').value;
                const C2_label = e.target.querySelector('#recipe-c2-label').value;
                const C2_content = e.target.querySelector('#recipe-c2-content').value;
                const C3_label = e.target.querySelector('#recipe-c3-label').value;
                const C3_content = e.target.querySelector('#recipe-c3-content').value;
                
                const menuIndex = businessData.menu.findIndex(m => m.id === id);
                if (menuIndex > -1) {
                    businessData.menu[menuIndex].name = name;
                    businessData.menu[menuIndex].resep = { C1_label, C1_content, C2_label, C2_content, C3_label, C3_content };
                } else {
                    businessData.menu.push({ id, name, hargaJual: 30000, hppBreakdown: [], resep: { C1_label, C1_content, C2_label, C2_content, C3_label, C3_content } });
                }
                saveData(); renderAll();
                DOMElements.recipeModal.classList.add('hidden');
            }

            function deleteRecipe(id) {
                if (confirm('Apakah Anda yakin ingin menghapus resep ini? Menu yang terhapus juga akan hilang dari Analisis Bisnis Plan.')) {
                    businessData.menu = businessData.menu.filter(m => m.id !== id);
                    saveData(); renderAll();
                    DOMElements.recipeModal.classList.add('hidden');
                }
            }

            function renderMenuAnalysis() {
                DOMElements.menuAnalysisContainer.innerHTML = '';
                const totalBiayaOperasional = businessData.modal.operational.reduce((sum, item) => sum + (item.cost || 0), 0);
                businessData.menu.forEach(item => {
                    const hpp = (item.hppBreakdown || []).reduce((sum, i) => sum + (i.cost || 0), 0);
                    const margin = item.hargaJual - hpp;
                    const bep = totalBiayaOperasional / margin;
                    const card = document.createElement('div');
                    card.className = 'bg-stone-50 p-4 rounded-lg border space-y-3';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h4 class="text-xl font-bold text-amber-700">${item.name}</h4>
                            <button data-id="${item.id}" class="kelola-menu-btn text-xs bg-amber-100 text-amber-800 font-semibold px-2 py-1 rounded hover:bg-amber-200">Kelola</button>
                        </div>
                        <div class="flex justify-between text-sm pt-2 border-t"><span>Harga Jual</span> <span class="font-semibold">${formatCurrency(item.hargaJual)}</span></div>
                        <div class="flex justify-between text-sm"><span>Harga Pokok (HPP)</span> <span class="hpp-text font-semibold">${formatCurrency(hpp)}</span></div>
                        <div class="flex justify-between text-sm"><span>Margin / Porsi</span> <span class="margin-text font-semibold text-green-600">${formatCurrency(margin)}</span></div>
                        <div class="flex justify-between text-sm"><span>BEP (Porsi / Bulan)</span> <span class="bep-text font-semibold text-blue-600">${isFinite(bep) && bep > 0 ? Math.ceil(bep) : 'N/A'} Porsi</span></div>
                    `;
                    DOMElements.menuAnalysisContainer.appendChild(card);
                });
            }
            
            function renderCapitalPlan() {
                const investmentContainer = document.getElementById('investment-cost-container');
                const operationalContainer = document.getElementById('operational-cost-container');
                
                investmentContainer.innerHTML = businessData.modal.investment.map((item, index) => `
                    <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-2 capital-item-row" data-type="investment" data-index="${index}">
                        <input type="text" value="${item.name}" placeholder="Nama Biaya" class="capital-item-name w-full bg-stone-50 p-2 rounded border">
                        <input type="number" value="${item.cost}" placeholder="0" class="capital-item-cost w-full md:w-32 bg-stone-50 p-2 rounded border">
                        <button type="button" class="delete-capital-item-btn text-red-500 hover:text-red-700 font-bold p-1 self-end md:self-center">‚úï</button>
                    </div>
                `).join('');

                operationalContainer.innerHTML = businessData.modal.operational.map((item, index) => `
                    <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-2 capital-item-row" data-type="operational" data-index="${index}">
                        <input type="text" value="${item.name}" placeholder="Nama Biaya" class="capital-item-name w-full bg-stone-50 p-2 rounded border">
                        <input type="number" value="${item.cost}" placeholder="0" class="capital-item-cost w-full md:w-32 bg-stone-50 p-2 rounded border">
                        <button type="button" class="delete-capital-item-btn text-red-500 hover:text-red-700 font-bold p-1 self-end md:self-center">‚úï</button>
                    </div>
                `).join('');

                updateCapitalTotals();
            }

            function updateCapitalTotals() {
                const totalInvestment = businessData.modal.investment.reduce((sum, item) => sum + (item.cost || 0), 0);
                const totalOperational = businessData.modal.operational.reduce((sum, item) => sum + (item.cost || 0), 0);
                document.getElementById('total-investment').textContent = formatCurrency(totalInvestment);
                document.getElementById('total-operational').textContent = formatCurrency(totalOperational);
                document.getElementById('total-modal-keseluruhan').textContent = formatCurrency(totalInvestment + totalOperational);
            }
            
            function openKelolaMenuModal(menuId) {
                const menu = businessData.menu.find(m => m.id === menuId);
                DOMElements.kelolaMenuModal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl m-4">
                    <h3 class="text-2xl font-bold mb-4">Kelola Menu: ${menu.name}</h3>
                    <form id="kelola-menu-form" class="space-y-6 max-h-[80vh] overflow-y-auto pr-4">
                        <input type="hidden" id="kelola-menu-id" value="${menu.id}">
                        <div>
                            <label for="kelola-harga-jual" class="block text-sm font-bold text-stone-700 mb-1">Harga Jual (Rp)</label>
                            <input type="number" id="kelola-harga-jual" value="${menu.hargaJual}" class="bg-stone-50 w-full rounded p-2">
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-lg font-bold mb-2">Rincian HPP (Harga Pokok Penjualan)</h4>
                            <div id="hpp-items-container" class="space-y-3">${(menu.hppBreakdown || []).map(item => `<div class="flex items-center space-x-2 hpp-item-row"><input type="text" value="${item.name}" class="hpp-item-name w-full bg-stone-50 p-2 rounded border"><input type="number" value="${item.cost}" class="hpp-item-cost w-32 bg-stone-50 p-2 rounded border"><button type="button" class="delete-hpp-item-btn text-red-500 hover:text-red-700 font-bold p-1">‚úï</button></div>`).join('')}</div>
                            <button type="button" id="add-hpp-item-btn" class="mt-3 w-full text-sm bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">+ Tambah Item HPP</button>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-lg font-bold mb-2">Kalkulator HPP per Porsi</h4>
                            <div class="p-4 bg-stone-50 rounded-lg space-y-2">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="text-sm">Harga Beli Bahan</label><input type="number" id="calc-harga-bahan" class="w-full p-2 rounded border"></div>
                                    <div><label class="text-sm">Jumlah Porsi</label><input type="number" id="calc-jumlah-porsi" class="w-full p-2 rounded border"></div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Biaya per Porsi:</span>
                                    <span id="calc-hasil-porsi" class="font-bold text-lg text-green-600">Rp 0</span>
                                </div>
                                <button type="button" id="add-calc-to-hpp-btn" class="w-full text-sm bg-green-100 text-green-800 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition">‚Üì Tambahkan ke Rincian HPP</button>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" class="cancel-modal-btn bg-stone-200 text-stone-800 font-bold py-2 px-4 rounded-lg hover:bg-stone-300">Tutup</button>
                            <button type="submit" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600">Simpan Perubahan</button>
                        </div>
                    </form>
                </div>`;
                DOMElements.kelolaMenuModal.classList.remove('hidden');
                DOMElements.kelolaMenuModal.classList.add('flex');
            }
            
            function saveKelolaMenu(e) {
                const menuId = e.target.querySelector('#kelola-menu-id').value;
                const menu = businessData.menu.find(m => m.id === menuId);
                
                menu.hargaJual = parseInt(e.target.querySelector('#kelola-harga-jual').value) || 0;

                const newBreakdown = [];
                e.target.querySelectorAll('.hpp-item-row').forEach(row => {
                    const name = row.querySelector('.hpp-item-name').value.trim();
                    const cost = parseInt(row.querySelector('.hpp-item-cost').value) || 0;
                    if (name) newBreakdown.push({ name, cost });
                });
                menu.hppBreakdown = newBreakdown;

                saveData(); renderMenuAnalysis();
                DOMElements.kelolaMenuModal.classList.add('hidden');
            }
            
            function renderPreOrders() {
                DOMElements.preOrderList.innerHTML = '';
                const activeOrders = preOrders.filter(o => o.status === 'proses');
                if (activeOrders.length === 0) {
                    DOMElements.preOrderList.innerHTML = `<p class="text-stone-500 italic md:col-span-3">Tidak ada pesanan aktif.</p>`;
                } else {
                    activeOrders.forEach(order => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow flex flex-col';
                        card.innerHTML = `
                            <h4 class="font-bold">${order.customer}</h4>
                            <p class="text-sm text-stone-500 mb-2">Ambil: ${new Date(order.date).toLocaleDateString('id-ID')}</p>
                            <p class="text-sm text-stone-700 flex-grow whitespace-pre-wrap">${order.details}</p>
                            <p class="font-bold text-amber-600 mt-2">${formatCurrency(order.amount)}</p>
                            <button data-id="${order.id}" class="complete-po-btn mt-4 w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition">Selesaikan Pesanan</button>
                        `;
                        DOMElements.preOrderList.appendChild(card);
                    });
                }
                DOMElements.poProses.textContent = preOrders.filter(o => o.status === 'proses').length;
                DOMElements.poSelesai.textContent = preOrders.filter(o => o.status === 'selesai').length;
            }

            async function addPreOrder(e) {
                const newOrder = {
                    customer: DOMElements.preOrderForm.querySelector('#po-customer').value,
                    date: DOMElements.preOrderForm.querySelector('#po-date').value,
                    details: DOMElements.preOrderForm.querySelector('#po-details').value,
                    amount: parseInt(DOMElements.preOrderForm.querySelector('#po-amount').value) || 0,
                    status: 'proses'
                };
                await savePreOrderFB(newOrder);
                preOrders = await getPreOrdersFB();
                saveData();
                renderPreOrders();
                DOMElements.preOrderForm.reset();
            }

            async function completePreOrder(id) {
                const order = preOrders.find(o => o.id === id);
                if (order) {
                    await completePreOrderFB(id, order);
                    preOrders = await getPreOrdersFB();
                    transactions = await getTransactionsFB();
                    saveData();
                    renderPreOrders();
                    renderTransactions();
                    updateDashboard();
                }
            }
            
            function createSalesTrendChart() {
                const ctx = document.getElementById('sales-trend-chart').getContext('2d');
                salesTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ label: 'Pemasukan Harian', data: [], backgroundColor: 'rgba(245, 158, 11, 0.2)', borderColor: 'rgba(245, 158, 11, 1)', borderWidth: 2, tension: 0.3, fill: true }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }

            function updateSalesTrendChart() {
                const now = new Date();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
                const data = Array(daysInMonth).fill(0);

                transactions.forEach(tx => {
                    const txDate = new Date(tx.date);
                    if (tx.type === 'Pemasukan' && txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear()) {
                        data[txDate.getDate() - 1] += tx.amount;
                    }
                });
                
                salesTrendChart.data.labels = labels;
                salesTrendChart.data.datasets[0].data = data;
                salesTrendChart.update();
            }

            document.addEventListener('input', e => {
                const target = e.target;
                if (target.matches('.capital-item-name, .capital-item-cost')) {
                    const row = target.closest('.capital-item-row');
                    const type = row.dataset.type;
                    const index = parseInt(row.dataset.index);
                    const name = row.querySelector('.capital-item-name').value;
                    const cost = parseInt(row.querySelector('.capital-item-cost').value) || 0;
                    businessData.modal[type][index] = { name, cost };
                    updateCapitalTotals(); renderMenuAnalysis(); updateDashboard(); saveData();
                }
                if (target.matches('#target-rupiah')) {
                    target.value = formatNumber(parseInt(target.value.replace(/\./g, '')) || 0);
                    businessData.targetBulananRp = parseInt(target.value.replace(/\./g, '')) || 0;
                    updateTargetSlider();
                    updateDashboard();
                    saveData();
                }
                if (target.matches('#target-harian')) {
                    DOMElements.targetHarianValue.textContent = `${target.value} Porsi`;
                }
                if (target.matches('#calc-harga-bahan, #calc-jumlah-porsi')) {
                    const modal = target.closest('.modal');
                    const harga = parseInt(modal.querySelector('#calc-harga-bahan').value) || 0;
                    const porsi = parseInt(modal.querySelector('#calc-jumlah-porsi').value) || 1;
                    const hasil = harga / porsi;
                    modal.querySelector('#calc-hasil-porsi').textContent = formatCurrency(hasil);
                }
            });
            
            document.addEventListener('change', e => { if(e.target.matches('.harga-jual-slider')) saveData(); });

            document.addEventListener('click', async e => {
                const target = e.target;
                if(target.matches('.delete-btn')) await deleteTransaction(target.dataset.id);
                if(target.matches('.edit-btn')) openEditModal(target.dataset.id);
                if(target.matches('.kelola-menu-btn')) openKelolaMenuModal(target.dataset.id);
                if(target.matches('.delete-capital-item-btn')) {
                    const row = target.closest('.capital-item-row');
                    const type = row.dataset.type;
                    const index = parseInt(row.dataset.index);
                    businessData.modal[type].splice(index, 1);
                    renderCapitalPlan(); renderMenuAnalysis(); updateDashboard(); saveData();
                }
                if(target.matches('#add-investment-btn, #add-operational-btn')) {
                    const type = target.id === 'add-investment-btn' ? 'investment' : 'operational';
                    businessData.modal[type].push({ name: '', cost: 0 });
                    renderCapitalPlan(); saveData();
                }
                if(target.matches('#add-recipe-btn')) openRecipeModal();
                if(target.matches('.kelola-resep-btn')) openRecipeModal(target.dataset.id);
                if(target.matches('.cancel-modal-btn')) target.closest('.modal').classList.add('hidden');
                if(target.matches('#delete-recipe-btn')) deleteRecipe(DOMElements.recipeModal.querySelector('#recipe-id').value);
                if(target.matches('.complete-po-btn')) await completePreOrder(target.dataset.id);
                if(target.matches('#add-hpp-item-btn')) {
                    const container = target.closest('form').querySelector('#hpp-items-container');
                    const newItemRow = document.createElement('div');
                    newItemRow.className = 'flex items-center space-x-2 hpp-item-row';
                    newItemRow.innerHTML = `<input type="text" placeholder="Nama Komponen Baru" class="hpp-item-name w-full bg-stone-50 p-2 rounded border"><input type="number" placeholder="0" class="hpp-item-cost w-32 bg-stone-50 p-2 rounded border"><button type="button" class="delete-hpp-item-btn text-red-500 hover:text-red-700 font-bold p-1">‚úï</button>`;
                    container.appendChild(newItemRow);
                }
                if(target.matches('.delete-hpp-item-btn')) target.closest('.hpp-item-row').remove();
                if(target.matches('#add-calc-to-hpp-btn')) {
                    const modal = target.closest('.modal');
                    const container = modal.querySelector('#hpp-items-container');
                    const harga = parseInt(modal.querySelector('#calc-harga-bahan').value) || 0;
                    const porsi = parseInt(modal.querySelector('#calc-jumlah-porsi').value) || 1;
                    const hasil = harga / porsi;
                    const newItemRow = document.createElement('div');
                    newItemRow.className = 'flex items-center space-x-2 hpp-item-row';
                    newItemRow.innerHTML = `<input type="text" value="Bahan Baku per Porsi" class="hpp-item-name w-full bg-stone-50 p-2 rounded border"><input type="number" value="${Math.round(hasil)}" class="hpp-item-cost w-32 bg-stone-50 p-2 rounded border"><button type="button" class="delete-hpp-item-btn text-red-500 hover:text-red-700 font-bold p-1">‚úï</button>`;
                    container.appendChild(newItemRow);
                }
            });

            document.addEventListener('submit', async e => {
                e.preventDefault();
                const target = e.target;
                if(target.matches('#transaction-form')) await addTransaction(e);
                if(target.matches('#edit-tx-form')) await saveEditTransaction(e);
                if(target.matches('#kelola-menu-form')) saveKelolaMenu(e);
                if(target.matches('#recipe-form')) saveRecipe(e);
                if(target.matches('#pre-order-form')) await addPreOrder(e);
            });

            DOMElements.txType.addEventListener('change', () => populateCategories(DOMElements.txCategory, DOMElements.txType.value));
            DOMElements.targetHarianSlider.addEventListener('input', () => { DOMElements.targetHarianValue.textContent = `${DOMElements.targetHarianSlider.value} Porsi`; });
            DOMElements.targetHarianSlider.addEventListener('change', () => {
                const dailyPortions = parseInt(DOMElements.targetHarianSlider.value);
                let avgPrice = businessData.menu.reduce((a, i) => a + i.hargaJual, 0) / businessData.menu.length;
                if (!isFinite(avgPrice) || avgPrice === 0) avgPrice = 30000;
                businessData.targetBulananRp = Math.round(dailyPortions * avgPrice * businessData.hariKerjaPerBulan);
                DOMElements.targetRupiahInput.value = formatNumber(businessData.targetBulananRp);
                updateDashboard();
                saveData();
            });

            async function initialize() {
                loadData();
                setupNavigation();
                DOMElements.txDate.valueAsDate = new Date();
                DOMElements.preOrderForm.querySelector('#po-date').valueAsDate = new Date();
                populateCategories(DOMElements.txCategory, 'Pemasukan');
                DOMElements.targetRupiahInput.value = formatNumber(businessData.targetBulananRp);
                createSalesTrendChart();

                // Fetch data dari Firestore lalu render
                transactions = await getTransactionsFB();
                preOrders = await getPreOrdersFB();

                renderAll();
                updateTargetSlider();
            }

            initialize();
        });
    </script>
</body>
</html>
```

